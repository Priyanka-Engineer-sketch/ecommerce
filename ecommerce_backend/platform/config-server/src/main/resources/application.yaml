# =========================
# Spring Cloud Config Server (runs on 8888)
# DEFAULT: HTTPS + PAT  (start with: no profile â†’ falls back to https via activate.on-profile: default)
# =========================
server:
  port: 8888

spring:
  application:
    name: config-server

  security:
    user:
      name: ${CONFIG_USER:config}
      password: ${CONFIG_PASS:configpass}

# ---------- PROFILE: HTTPS + PAT  ----------
# Activate implicitly as default (no profile) OR explicitly with: --spring.profiles.active=https
---
spring:
  config:
    activate:
      on-profile: https,default
  cloud:
    config:
      server:
        git:
          uri: ${CONFIG_GIT_URI:https://github.com/Priyanka-Engineer-sketch/ecom-config.git}
          # MUST be a GitHub PAT (NOT your account password)
          username: ${CONFIG_GIT_USERNAME:}
          password: ${CONFIG_GIT_PASSWORD:}
          default-label: ${CONFIG_GIT_BRANCH:main}
          search-paths: ${CONFIG_GIT_PATHS:}
          clone-on-start: true
          skip-ssl-validation: ${CONFIG_GIT_SKIP_SSL:false}
          timeout: ${CONFIG_GIT_TIMEOUT:20}
          force-pull: ${CONFIG_GIT_FORCE_PULL:true}
          delete-untracked-branches: true

encrypt:
  key: ${CONFIG_ENCRYPT_KEY:}   # supply via secret; do NOT commit plaintext

logging:
  level:
    root: INFO
    org.springframework.cloud.config.server: INFO
    org.eclipse.jgit: INFO

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      probes:
        enabled: true

eureka:
  client:
    register-with-eureka: ${EUREKA_REGISTER:false}
    fetch-registry: ${EUREKA_FETCH:false}
    serviceUrl:
      defaultZone: ${EUREKA_SERVER_URL:http://localhost:8761/eureka}
  instance:
    prefer-ip-address: true

# ---------- PROFILE: SSH (INLINE PEM) ----------
# Use when you want to pass the key CONTENTS via env var (works best on Windows).
# Start with: --spring.profiles.active=ssh-inline
---
spring:
  config:
    activate:
      on-profile: ssh-inline
  cloud:
    config:
      server:
        git:
          uri: ${CONFIG_GIT_URI:git@github.com:Priyanka-Engineer-sketch/ecom-config.git}
          # IMPORTANT: This must be the ACTUAL PEM text (BEGIN/END) with \n newlines
          # Example (PowerShell): setx CONFIG_GIT_SSH_KEY_PEM "-----BEGIN RSA PRIVATE KEY-----`n...`n-----END RSA PRIVATE KEY-----"
          privateKey: ${CONFIG_GIT_SSH_KEY_PEM:}
          passphrase: ${CONFIG_GIT_SSH_PASSPHRASE:}
          ignoreLocalSshSettings: ${CONFIG_GIT_IGNORE_LOCAL_SSH:true}
          strictHostKeyChecking: ${CONFIG_GIT_STRICT_HOST_KEY:false}
          hostKey: ${CONFIG_GIT_HOST_KEY:}
          hostKeyAlgorithm: ${CONFIG_GIT_HOST_KEY_ALGO:}
          default-label: ${CONFIG_GIT_BRANCH:main}
          search-paths: ${CONFIG_GIT_PATHS:}
          clone-on-start: true
          timeout: ${CONFIG_GIT_TIMEOUT:20}
          force-pull: ${CONFIG_GIT_FORCE_PULL:true}
          delete-untracked-branches: true

# ---------- PROFILE: SSH (USE ~/.ssh & known_hosts) ----------
# Works if your key is in the default location (e.g., C:\Users\Admin\.ssh\id_rsa in PEM format)
# and known_hosts contains GitHub (ssh-rsa entry).
# Start with: --spring.profiles.active=ssh-home
---
spring:
  config:
    activate:
      on-profile: ssh-home
  cloud:
    config:
      server:
        git:
          uri: ${CONFIG_GIT_URI:git@github.com:Priyanka-Engineer-sketch/ecom-config.git}
          # Let JGit read ~/.ssh/id_rsa and ~/.ssh/known_hosts
          ignoreLocalSshSettings: false
          # If you insist on strict checking, set true and provide hostKey/hostKeyAlgorithm
          strictHostKeyChecking: ${CONFIG_GIT_STRICT_HOST_KEY:false}
          default-label: ${CONFIG_GIT_BRANCH:main}
          search-paths: ${CONFIG_GIT_PATHS:}
          clone-on-start: true
          timeout: ${CONFIG_GIT_TIMEOUT:20}
          force-pull: ${CONFIG_GIT_FORCE_PULL:true}
          delete-untracked-branches: true

# ---------- PROFILE: Native (local folder backend) ----------
# Start with: --spring.profiles.active=native
---
spring:
  config:
    activate:
      on-profile: native
  cloud:
    config:
      server:
        native:
          search-locations:
            - ${CONFIG_NATIVE_DIR:./config-repo}

server:
  port: 8888


#Generate key in PEM (RSA) format:
#  ssh-keygen -t rsa -b 4096 -m PEM -C "config-server" -f $env:USERPROFILE\.ssh\config-server-rsa -N ""
#  Add config-server-rsa.pub as a Deploy key (Read-only) to the repo.
#Put private key contents into env var with \n line breaks:
#  $pem = [IO.File]::ReadAllText("$env:USERPROFILE\.ssh\config-server-rsa") -replace "`r?`n","`n"
#  setx CONFIG_GIT_SSH_KEY_PEM $pem
